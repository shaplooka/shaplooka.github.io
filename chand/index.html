<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U Playlist Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
        }
        #videoPlayer {
            width: 80%;
            max-width: 800px;
            margin: 20px auto;
            display: block;
        }
        #searchBox {
            width: 80%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        #playlistLinks {
            text-align: left;
            margin: 0 auto;
            width: 80%;
            max-width: 600px;
        }
        a {
            display: block;
            margin: 10px 0;
            color: #007bff;
            text-decoration: none;
            font-size: 16px;
        }
        a:hover {
            text-decoration: underline;
        }
        .error {
            color: red;
            font-size: 14px;
        }
    </style>
    <!-- Include HLS.js library -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <video id="videoPlayer" controls>
        Your browser does not support the video tag.
    </video>
    <input type="text" id="searchBox" placeholder="Search for a stream..." oninput="filterPlaylist()">
    <div id="playlistLinks">Loading playlist links...</div>

    <script>
        const m3uPlaylistUrl = "https://shaplooka.github.io/chand/Ejaz.m3u"; // M3U playlist URL
        const playlistLinksContainer = document.getElementById('playlistLinks');
        const videoElement = document.getElementById('videoPlayer');
        const searchBox = document.getElementById('searchBox');
        let hls;
        let playlistData = [];

        // Function to fetch and parse the M3U playlist
        function fetchAndParsePlaylist() {
            fetch(m3uPlaylistUrl)
                .then(response => response.text())
                .then(data => {
                    playlistData = parsePlaylist(data);
                    if (playlistData.length > 0) {
                        displayPlaylistLinks(playlistData);
                    } else {
                        playlistLinksContainer.textContent = "No valid links found in the playlist.";
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch M3U playlist:', error);
                    playlistLinksContainer.textContent = "Error: Failed to fetch playlist.";
                });
        }

        // Function to parse the M3U playlist and extract stream names and URLs
        function parsePlaylist(data) {
            const lines = data.split('\n');
            const playlist = [];
            let currentTitle = "";

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    // Extract the title from the #EXTINF line
                    const title = lines[i].split(',').pop().trim();
                    currentTitle = title;
                } else if (lines[i].startsWith('http')) {
                    // Add the title and URL to the playlist
                    playlist.push({ title: currentTitle, url: lines[i] });
                }
            }
            return playlist;
        }

        // Function to display the playlist links
        function displayPlaylistLinks(playlist) {
            playlistLinksContainer.innerHTML = ""; // Clear loading message
            playlist.forEach((item, index) => {
                const linkElement = document.createElement('a');
                linkElement.href = "#";
                linkElement.textContent = item.title;
                linkElement.dataset.url = item.url;
                linkElement.onclick = () => playStream(item.url);
                playlistLinksContainer.appendChild(linkElement);
            });
        }

        // Function to play the selected stream
        function playStream(url) {
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                hls = new Hls({
                    maxBufferLength: 30, // Adjust buffer length
                    maxMaxBufferLength: 60, // Adjust max buffer length
                    enableWorker: true, // Enable Web Worker for better performance
                });
                hls.loadSource(url);
                hls.attachMedia(videoElement);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log("Manifest parsed, starting playback.");
                    videoElement.play();
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error("Network error. Trying to recover...");
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error("Media error. Trying to recover...");
                                hls.recoverMediaError();
                                break;
                            default:
                                console.error("Fatal error. Cannot recover.");
                                displayError("This stream is not working.");
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                videoElement.src = url;
                videoElement.addEventListener('error', () => {
                    displayError("This stream is not working.");
                });
            } else {
                displayError("HLS is not supported in this browser.");
            }
        }

        // Function to display an error message
        function displayError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = "error";
            errorElement.textContent = message;
            playlistLinksContainer.appendChild(errorElement);
            setTimeout(() => {
                errorElement.remove();
            }, 3000); // Remove error message after 3 seconds
        }

        // Function to filter the playlist based on search input
        function filterPlaylist() {
            const searchTerm = searchBox.value.toLowerCase();
            const filteredPlaylist = playlistData.filter(item =>
                item.title.toLowerCase().includes(searchTerm)
            );
            displayPlaylistLinks(filteredPlaylist);
        }

        // Fetch and parse the playlist when the page loads
        fetchAndParsePlaylist();

        // Auto-refresh the playlist every 5 minutes (300,000 milliseconds)
        setInterval(fetchAndParsePlaylist, 300000);
    </script>
</body>
</html>